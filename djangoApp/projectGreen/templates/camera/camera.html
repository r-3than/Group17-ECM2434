<!doctype html>
{% load static %}
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
        <link href="{% static 'css/camera.css' %}" rel="stylesheet">
        <link href="{% static 'css/variables.css' %}" rel="stylesheet">
    </head>
    <body>
        <header class="row">
            <div class="side"></div>
            <div class="title centre">
                <a class="title">BeGreen</a>
                <br>
                <a class="subtitle">Today's challenge: Visit the Coast!</a>
            </div>
            <div class="side">
                <div class="account">
                    <div style="height: 80%; padding-left: 50%;">
                        <div class="icon rounded-circle">{{user.username|make_list|first| capfirst}}</div>
                    </div>
                    <div class="points">Score: 312</div>
                </div>
            </div>
        </header>
        <main>
            <div class="content">
                <video id="playbackvideo" autoplay></video>
                <canvas id="canvas" style="display: none;"> </canvas>
                <img id="photo" style="display: none;"/>
                <!-- <input
                type="file"
                id="upload_pic"
                name="upload_pic"
                accept=".jpg, .jpeg, .png"
                capture="camera" /> -->
            </div>
            <div class="row">
                <div class="side">
                    <button id="undo" class="capture rounded-circle" style="visibility: hidden;">
                        <div class="inner-capture rounded-circle">
                            <img class="icon" src="{% static 'img/Undo.svg' %}">
                        </div>
                    </button>        
                </div>
                <div class="centre">
                    <button id="capture" class="capture rounded-circle">
                        <div class="inner-capture rounded-circle">
                            <img class="icon" id="tick" src="{% static 'img/Confirm.svg' %}" style="visibility: hidden;">
                        </div>
                    </button>
                </div>
                <div class="side"></div>
            </div>
            
        </main>
        <script>
        // Get elements
        capture = document.getElementById("capture");
        capture.addEventListener("click", getImage);
        undo = document.getElementById("undo");
        undo.addEventListener("click", discardImage);
        video = document.getElementById("playbackvideo");
        canvas = document.getElementById("canvas");
        photo = document.getElementById("photo");
        photo.addEventListener("click", sendImage);

        // Capture image
        function getImage() {
            const context = canvas.getContext("2d");
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, video.videoWidth, video.videoHeight);

            const data = canvas.toDataURL("image/png");
            photo.setAttribute("src", data);
            photo.setAttribute("style", "");
            //get frame from stream here and send a post request to backend in django (need db)

            video.setAttribute("style", "display: none;");
            undo.setAttribute("style", "visibility: visible;");
            document.getElementById("tick").setAttribute("style", "visibility: visible");
            capture.addEventListener("click", sendImage);
            capture.removeEventListener("click", getImage);
        }

        function discardImage() {
            photo.setAttribute("style", "display: none;");
            video.setAttribute("style", "display: block;");
            undo.setAttribute("style", "visibility: hidden;");
            document.getElementById("tick").setAttribute("style", "visibility: hidden");
            capture.removeEventListener("click", sendImage);
            capture.addEventListener("click", getImage);
        }

        // Send image
        function sendImage() {
            fetch("http://localhost:8000/uploadphoto/", {
            method: "POST",
            credentials: 'include',
            headers: {
                Accept: "application/json",
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                img: canvas.toDataURL("image/png"),
            }),
            })
            .then((response) => response.json())
            .then((response) => console.log(JSON.stringify(response)));
        }

        var errorCallback = function (e) {
            console.log("Perms denied!", e);
        };
        navigator.getUserMedia =
            navigator.getUserMedia ||
            navigator.webkitGetUserMedia ||
            navigator.mozGetUserMedia ||
            navigator.msGetUserMedia;

        // Not showing vendor prefixes.
        navigator.getUserMedia(
            { video: true, audio: true },
            function (localMediaStream) {
            var video = document.querySelector("video");
            video.srcObject = localMediaStream;

            // Note: onloadedmetadata doesn't fire in Chrome when using it with getUserMedia.
            // See crbug.com/110938.
            video.onloadedmetadata = function (e) {
                // Ready to go. Do some stuff.
            };
            },
            errorCallback
        );
        </script>
    </body>
</html>